<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Token Swap</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
</head>
<body style="font-family:sans-serif;padding:20px;">
  <h2>Swap</h2>

  <!-- Wallet connection -->
  <button id="connectBtn">Connect Wallet</button>
  <p id="walletAddress">Not connected</p>

  <!-- Swap UI -->
  <div>
    <label>From:</label>
    <select id="fromSel"></select>
    <input type="text" id="fromAmount" placeholder="Amount"/>
  </div>

  <div>
    <label>To:</label>
    <select id="toSel"></select>
    <input type="text" id="toAmount" placeholder="Est. Output" readonly/>
  </div>

  <button id="swapBtn">Swap</button>
  <p id="status"></p>

<script>
const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
let signer, account;

const TOKENS = {
  USD1: { symbol:"USD1", address:"0x8d0D000Ee44948FC98c9B98A4FA4921476f08B0d" },
  T:    { symbol:"T",    address:"0x7E3286FF19b2c9CC80cf7013F32C3BA3e13e9C01" }
};
const WBNB = "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";
const ROUTER = "0x10ED43C718714eb63d5aA57B78B54704E256024E"; // PancakeSwap V2 router
const routerAbi = [
  "function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)",
  "function swapExactTokensForTokens(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) external returns (uint[] memory amounts)"
];
const tokenAbi = [
  "function approve(address spender,uint amount) external returns (bool)",
  "function allowance(address owner,address spender) external view returns (uint)"
];
const router = new ethers.Contract(ROUTER, routerAbi, provider);

// init token dropdowns
const fromSel = document.getElementById("fromSel");
const toSel = document.getElementById("toSel");
Object.values(TOKENS).forEach(t=>{
  let opt1=document.createElement("option"); opt1.value=t.address; opt1.textContent=t.symbol; fromSel.append(opt1);
  let opt2=document.createElement("option"); opt2.value=t.address; opt2.textContent=t.symbol; toSel.append(opt2);
});
fromSel.selectedIndex=0; toSel.selectedIndex=1;

// connect wallet
document.getElementById("connectBtn").onclick = async ()=>{
  if (!window.ethereum){ alert("MetaMask not found"); return; }
  try {
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    account = await signer.getAddress();
    document.getElementById("walletAddress").textContent = account;

    // ensure BSC mainnet
    await provider.send("wallet_switchEthereumChain", [{ chainId: "0x38" }]);
  } catch(err){ console.error(err); alert("Connect error: "+err.message); }
};

// auto output preview
document.getElementById("fromAmount").oninput = updateQuote;
fromSel.onchange = updateQuote; toSel.onchange = updateQuote;

async function updateQuote(){
  if(!fromSel.value || !toSel.value) return;
  const amt=document.getElementById("fromAmount").value;
  if(!amt) return;
  try{
    const path = getPath();
    const amounts=await router.getAmountsOut(ethers.utils.parseUnits(amt,18), path);
    document.getElementById("toAmount").value = ethers.utils.formatUnits(amounts[amounts.length-1],18);
  }catch(e){ document.getElementById("toAmount").value=""; }
}

function getPath(){
  const from=fromSel.value, to=toSel.value;
  if((from===TOKENS.USD1.address && to===TOKENS.T.address) ||
     (from===TOKENS.T.address && to===TOKENS.USD1.address)){
    return [from,to];
  }
  return [from,WBNB,to]; // fallback via WBNB
}

// swap
document.getElementById("swapBtn").onclick = async ()=>{
  if(!signer){ alert("Connect wallet first"); return; }
  try{
    const amtIn=document.getElementById("fromAmount").value;
    const amtInWei=ethers.utils.parseUnits(amtIn,18);
    const path=getPath();
    const token=new ethers.Contract(path[0],tokenAbi,signer);

    const allowance=await token.allowance(account,ROUTER);
    if(allowance.lt(amtInWei)){
      document.getElementById("status").textContent="Approving...";
      let tx=await token.approve(ROUTER,amtInWei);
      await tx.wait();
    }

    document.getElementById("status").textContent="Swapping...";
    const routerWithSigner=router.connect(signer);
    const amounts=await router.getAmountsOut(amtInWei,path);
    const minOut=amounts[amounts.length-1].mul(95).div(100); // 5% slippage

    let tx=await routerWithSigner.swapExactTokensForTokens(
      amtInWei,
      minOut,
      path,
      account,
      Math.floor(Date.now()/1000)+1200
    );
    await tx.wait();
    document.getElementById("status").textContent="Swap successful âœ…";
  }catch(err){
    console.error(err);
    document.getElementById("status").textContent="Swap failed: "+(err.data?.message || err.message);
  }
};
</script>
</body>
</html>
