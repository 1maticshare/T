<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T ↔ USD1 Swap (BSC)</title>
  <link rel="shortcut icon" href="./assets/T.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--card:#111833;--muted:#6b7280;--text:#e5e7eb;--accent:#7c3aed;--accent2:#22c55e;--border:#1f2a44}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 70% -200px,#18223f,transparent),var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:grid;place-items:center;padding:24px}
    .wrap{width:100%;max-width:560px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border:1px solid var(--border);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
    .header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border)}
    .header h1{font-size:18px;margin:0;letter-spacing:.3px}
    .net{font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;color:#0b1020;background:#fff;cursor:pointer;transition:.2s transform,.2s opacity}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.secondary{background:#1f2937;color:#cbd5e1;border:1px solid #324156}
    .btn.accent{background:linear-gradient(135deg,var(--accent),#06b6d4);color:white}
    .btn.success{background:linear-gradient(135deg,var(--accent2),#16a34a);color:white}
    .row{display:flex;gap:10px}
    .panel{padding:16px 20px;border-bottom:1px solid var(--border)}
    .token-box{background:#0e1530;border:1px solid var(--border);border-radius:16px;padding:14px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .token-side{display:flex;align-items:center;gap:10px}
    .token-select{display:flex;flex-direction:column}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="text"], select{background:#0b1125;border:1px solid var(--border);color:var(--text);padding:12px;border-radius:12px;width:100%;font-size:16px}
    input[readonly]{opacity:.8}
    .swap-mid{display:flex;align-items:center;justify-content:center;margin:10px 0}
    .swap-mid button{width:44px;height:44px;border-radius:999px;background:#1f2937;color:#cbd5e1;border:1px solid #324156}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .meta{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;font-size:13px;color:#a5b4fc}
    .muted{color:var(--muted)}
    .foot{display:flex;gap:10px;align-items:center}
    a{color:#93c5fd;text-decoration:none}
    .tag{font-size:11px;border:1px solid #334155;color:#cbd5e1;padding:4px 8px;border-radius:999px}
    .status{font-size:12px;color:#cbd5e1}
    .link{overflow-wrap:anywhere}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1>T ↔ USD1 Swap (BSC)</h1>
        <div class="row">
          <div class="net" id="network"><!--Disconnected--!></div>
          <button class="btn accent" id="connectBtn">Connect Wallet</button>
        </div>
      </div>

      <div class="panel">
        <div class="label">From</div>
        <div class="token-box">
          <div class="token-side" style="flex:1">
            <div class="token-select" style="min-width:220px">
              <select id="fromToken">
                <!-- Pre-filled with USD1 and T; you can add more options -->
                <option value="0x8d0D000Ee44948FC98c9B98A4FA4921476f08B0d" selected><img src="./Partner/11.png" alt="" width="10px"
                  height="10px">USD1 (World Liberty Financial)</option>
                <option value="0x7b47B9E05262C737B562C4881444370aA50234d4"><img src="./Partner/10.png" alt="" width="10px"
                  height="10px">T (Trump Mobile)</option>
              </select>
              <small class="muted">Pair: 0x7E3286FF19b2c9CC80cf7013F32C3BA3e13e9C01</small>
            </div>
          </div>
          <input id="fromAmount" type="text" placeholder="0.0" inputmode="decimal" style="max-width:220px" />
        </div>
        <div class="meta" style="margin-top:10px">
          <div>
            <span class="tag" id="fromSym">—</span>
            <span class="muted">Balance:</span> <span id="fromBal">—</span>
            <span class="muted">Allowance:</span> <span id="fromAll">—</span>
          </div>
          <button class="btn secondary" id="maxBtn">Max</button>
        </div>
      </div>

      <div class="swap-mid">
        <button id="flipBtn">⇅</button>
      </div>

      <div class="panel">
        <div class="label">To (estimated)</div>
        <div class="token-box">
          <div class="token-side" style="flex:1">
            <div class="token-select" style="min-width:220px">
              <select id="toToken">
                <option value="0x7b47B9E05262C737B562C4881444370aA50234d4"><img src="./Partner/10.png" alt="" width="10px"
                  height="10px">T (Trump Mobile)</option>
                <option value="0x8d0D000Ee44948FC98c9B98A4FA4921476f08B0d"><img src="./Partner/11.png" alt="" width="10px"
                  height="10px">USD1 (World Liberty Financial)</option>
              </select>
            </div>
          </div>
          <input id="toAmount" type="text" placeholder="0.0" inputmode="decimal" style="max-width:220px" readonly />
        </div>
        <div class="meta" style="margin-top:10px">
          <div>
            <span class="tag" id="toSym">—</span>
            <span class="muted">Min received:</span> <span id="minOut">—</span>
          </div>
          <div class="muted" id="priceHint">—</div>
        </div>
      </div>

      <div class="panel">
        <div class="grid">
          <label>
            <div class="label">Slippage (%)</div>
            <input id="slippage" type="text" value="0.5" />
          </label>
          <label>
            <div class="label">Deadline (mins)</div>
            <input id="deadline" type="text" value="20" />
          </label>
        </div>
      </div>

     <div class="panel">
        <div class="row">
          <button class="btn secondary" id="approveBtn" disabled>Approve</button>
          <button class="btn success" id="swapBtn" disabled>Swap</button>
        </div>
        <div class="status" id="status" style="margin-top:10px">—</div>
        <div class="status link" id="txlink"></div>
      </div>

     <div class="panel" style="display:flex;gap:10px;align-items:center;justify-content:space-between">
        <!--<div class="muted">Router: PancakeSwap v2</div>
        <a href="https://pancakeswap.finance/swap?outputCurrency=0x7b47B9E05262C737B562C4881444370aA50234d4&inputCurrency=0x8d0D000Ee44948FC98c9B98A4FA4921476f08B0d" target="_blank">Open on PancakeSwap</a>--!>
      </div>
    </div>
  </div>
<center><a href="https://trumpmobile.meme" target="_blank">
   <img alt="TrumpMobile" src="./assets/img/logo.png"></a></center>
<script>
(async function(){
  const { ethers } = window.ethers;

  // --- Constants ---
  const CHAIN_ID = 56; // BSC mainnet
  const RPC_PARAMS = {
    chainId: '0x38',
    chainName: 'BNB Smart Chain',
    nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
    rpcUrls: ['https://bsc-dataseed1.binance.org','https://bsc-dataseed2.defibit.io'],
    blockExplorerUrls: ['https://bscscan.com/']
  };

  const PANCAKE_ROUTER_V2 = '0x10ED43C718714eb63d5aA57B78B54704E256024E';

  const ERC20_ABI = [
    'function name() view returns (string)',
    'function symbol() view returns (string)',
    'function decimals() view returns (uint8)',
    'function balanceOf(address) view returns (uint256)',
    'function allowance(address owner, address spender) view returns (uint256)',
    'function approve(address spender, uint256 amount) returns (bool)'
  ];

  const ROUTER_ABI = [
    'function getAmountsOut(uint amountIn, address[] calldata path) external view returns (uint[] memory amounts)',
    'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)'
  ];

  const TOKENS = {
    USD1: { address: '0x8d0D000Ee44948FC98c9B98A4FA4921476f08B0d' },
    T:    { address: '0x7b47B9E05262C737B562C4881444370aA50234d4' }
  };

  // --- Elements ---
  const connectBtn = document.getElementById('connectBtn');
  const approveBtn = document.getElementById('approveBtn');
  const swapBtn = document.getElementById('swapBtn');
  const fromSel = document.getElementById('fromToken');
  const toSel = document.getElementById('toToken');
  const fromAmt = document.getElementById('fromAmount');
  const toAmt = document.getElementById('toAmount');
  const slippage = document.getElementById('slippage');
  const deadline = document.getElementById('deadline');
  const fromBal = document.getElementById('fromBal');
  const fromAll = document.getElementById('fromAll');
  const fromSym = document.getElementById('fromSym');
  const toSym = document.getElementById('toSym');
  const statusEl = document.getElementById('status');
  const txlinkEl = document.getElementById('txlink');
  const maxBtn = document.getElementById('maxBtn');
  const flipBtn = document.getElementById('flipBtn');
  const netEl = document.getElementById('network');
  const priceHint = document.getElementById('priceHint');

  let provider, signer, account;
  let router;
  const tokenMeta = {}; // address -> {symbol, decimals}

  function fmt(x, d=4){
    try{
      const n = Number(x);
      if(!isFinite(n)) return '—';
      if(n===0) return '0';
      if(n<1e-6) return n.toExponential(2);
      return n.toLocaleString(undefined,{maximumFractionDigits:d});
    }catch{return '—'}
  }

  function setStatus(msg){ statusEl.textContent = msg || '—'; txlinkEl.textContent=''; }

  function setTx(hash){
    txlinkEl.innerHTML = `<a href="https://bscscan.com/tx/${hash}" target="_blank">View on BscScan</a>`;
  }

  function ensureDifferent(){
    if(fromSel.value.toLowerCase()===toSel.value.toLowerCase()){
      // auto flip to keep different
      [...toSel.options].forEach((o,i)=>{ if(o.value.toLowerCase()!==fromSel.value.toLowerCase()) toSel.selectedIndex=i; });
    }
  }

  async function connect(){
    if(!window.ethereum){ alert('No wallet found. Please install MetaMask.'); return; }
    try{
      const current = await window.ethereum.request({ method:'eth_chainId' });
      if(current !== '0x38'){
        try{ await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId:'0x38' }] }); }
        catch(e){
          if(e.code === 4902){ await window.ethereum.request({ method:'wallet_addEthereumChain', params:[RPC_PARAMS] }); }
          else throw e;
        }
      }
      await window.ethereum.request({ method:'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      account = await signer.getAddress();
      const net = await provider.getNetwork();
      netEl.textContent = `Connected: BSC (#${net.chainId})`;
      connectBtn.textContent = account.slice(0,6)+'…'+account.slice(-4);
      connectBtn.disabled = true;
      router = new ethers.Contract(PANCAKE_ROUTER_V2, ROUTER_ABI, signer);
      await refreshMeta();
      await refreshBalances();
      await quote();
    } catch(err){ console.error(err); setStatus(err.message || 'Connect failed'); }
  }

  async function readTokenMeta(addr){
    const key = addr.toLowerCase();
    if(tokenMeta[key]) return tokenMeta[key];
    const c = new ethers.Contract(addr, ERC20_ABI, provider || new ethers.providers.JsonRpcProvider(RPC_PARAMS.rpcUrls[0]));
    const [symbol, decimals] = await Promise.all([c.symbol(), c.decimals()]);
    tokenMeta[key] = { symbol, decimals, contract:c };
    return tokenMeta[key];
  }

  async function refreshMeta(){
    const from = fromSel.value; const to = toSel.value;
    const [mFrom, mTo] = await Promise.all([readTokenMeta(from), readTokenMeta(to)]);
    fromSym.textContent = mFrom.symbol;
    toSym.textContent   = mTo.symbol;
  }

  async function refreshBalances(){
    if(!account) return;
    const from = fromSel.value; const to = toSel.value;
    const mFrom = await readTokenMeta(from);
    const mTo   = await readTokenMeta(to);
    const [balFrom, balTo, allowance] = await Promise.all([
      mFrom.contract.balanceOf(account),
      mTo.contract.balanceOf(account),
      mFrom.contract.allowance(account, PANCAKE_ROUTER_V2)
    ]);
    fromBal.textContent = fmt(ethers.utils.formatUnits(balFrom, mFrom.decimals));
    fromAll.textContent = fmt(ethers.utils.formatUnits(allowance, mFrom.decimals));
    // Enable/disable Approve/Swap
    const amountIn = fromAmt.value ? ethers.utils.parseUnits(fromAmt.value || '0', mFrom.decimals) : ethers.constants.Zero;
    const enoughAllowance = allowance.gte(amountIn) && !amountIn.isZero();
    approveBtn.disabled = !account || amountIn.isZero() || enoughAllowance;
    swapBtn.disabled    = !account || amountIn.isZero();
  }

  function getPath(){ return [fromSel.value, toSel.value]; }

  async function quote(){
    try{
      await refreshMeta();
      const from = fromSel.value; const to = toSel.value;
      const mFrom = await readTokenMeta(from); const mTo = await readTokenMeta(to);
      if(!fromAmt.value || Number(fromAmt.value)<=0){ toAmt.value=''; document.getElementById('minOut').textContent='—'; priceHint.textContent='—'; await refreshBalances(); return; }
      const amountIn = ethers.utils.parseUnits(fromAmt.value, mFrom.decimals);
      const amounts = await router.getAmountsOut(amountIn, getPath());
      const out = amounts[amounts.length-1];
      const outHuman = ethers.utils.formatUnits(out, mTo.decimals);
      toAmt.value = outHuman;
      // slippage
      const slip = Math.max(0, Number(slippage.value||'0'))/100;
      const minOut = out.mul(ethers.BigNumber.from(10000 - Math.floor(slip*10000))).div(10000);
      document.getElementById('minOut').textContent = fmt(ethers.utils.formatUnits(minOut, mTo.decimals));
      priceHint.textContent = `Price: 1 ${mFrom.symbol} ≈ ${fmt(Number(outHuman)/Number(fromAmt.value), 6)} ${mTo.symbol}`;
      await refreshBalances();
    } catch(err){ console.warn(err); toAmt.value=''; document.getElementById('minOut').textContent='—'; priceHint.textContent='—'; }
  }

  async function doApprove(){
    try{
      setStatus('Approving…');
      const mFrom = await readTokenMeta(fromSel.value);
      const tx = await mFrom.contract.connect(signer).approve(PANCAKE_ROUTER_V2, ethers.constants.MaxUint256);
      setTx(tx.hash);
      await tx.wait();
      setStatus('Approved ✅');
      await refreshBalances();
      await quote();
    } catch(err){ console.error(err); setStatus('Approve failed: '+(err.data?.message || err.message)); }
  }

  async function doSwap(){
    try{
      setStatus('Submitting swap…');
      const [mFrom, mTo] = await Promise.all([readTokenMeta(fromSel.value), readTokenMeta(toSel.value)]);
      const amountIn  = ethers.utils.parseUnits(fromAmt.value, mFrom.decimals);
      const quoteOuts = await router.getAmountsOut(amountIn, getPath());
      const out       = quoteOuts[quoteOuts.length-1];
      const slipPct   = Math.max(0, Number(slippage.value||'0'))/100;
      const minOut    = out.mul(ethers.BigNumber.from(10000 - Math.floor(slipPct*10000))).div(10000);
      const ddl       = Math.max(1, parseInt(deadline.value||'20',10));
      const dlUnix    = Math.floor(Date.now()/1000) + ddl*60;
      const tx = await router.swapExactTokensForTokens(
        amountIn, minOut, getPath(), account, dlUnix
      );
      setTx(tx.hash);
      setStatus('Waiting for confirmation…');
      const rec = await tx.wait();
      setStatus('Swap executed ✅');
      await refreshBalances();
      await quote();
    } catch(err){ console.error(err); setStatus('Swap failed: '+(err.data?.message || err.message)); }
  }

  function flip(){
    const a = fromSel.selectedIndex; const b = toSel.selectedIndex;
    fromSel.selectedIndex = b===a ? (a===0?1:0) : b;
    toSel.selectedIndex   = a;
    ensureDifferent();
    quote();
  }

  // --- Wire up ---
  connectBtn.addEventListener('click', connect);
  approveBtn.addEventListener('click', doApprove);
  swapBtn.addEventListener('click', doSwap);
  fromSel.addEventListener('change', ()=>{ ensureDifferent(); quote(); });
  toSel.addEventListener('change', ()=>{ ensureDifferent(); quote(); });
  fromAmt.addEventListener('input', ()=>{ quote(); });
  slippage.addEventListener('input', ()=>{ quote(); });
  deadline.addEventListener('input', ()=>{});
  maxBtn.addEventListener('click', async ()=>{
    if(!account) return; const mFrom = await readTokenMeta(fromSel.value);
    const bal = await tokenMeta[fromSel.value.toLowerCase()].contract.balanceOf(account);
    fromAmt.value = ethers.utils.formatUnits(bal, mFrom.decimals);
    quote();
  });
  flipBtn.addEventListener('click', flip);

  // Preload metadata for default tokens
  try{
    provider = new ethers.providers.JsonRpcProvider(RPC_PARAMS.rpcUrls[0]);
    await refreshMeta();
  } catch(e){}
})();
</script>
</body>
</html>
